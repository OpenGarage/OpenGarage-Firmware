<!DOCTYPE html>
<html>

<head>
    <title>Open Garage</title>
    <link href="./output.css" rel="stylesheet">
</head>

<body class="hidden">
    <div class="drawer">
        <input id="og-drawer" type="checkbox" class="drawer-toggle" />
        <div class="drawer-content max-h-screen flex flex-col" id="drawer-content">
            <div class="flex-1 overflow-auto flex flex-col gap-4">
                <table class="table">
                    </thead>
                    <tbody>
                    <tr>
                        <th>Last Update</th>
                        <td id="current-time"></td>
                    </tr>
                    <tr>
                        <th>Start Time</th>
                        <td id="start-time"></td>
                    </tr>
                    <tr>
                        <th>Uptime</th>
                        <td id="uptime"></td>
                    </tr>
                    <tr>
                        <th>Record Count</th>
                        <td id="record-count"></td>
                    </tr>
                    </tbody>
                </table>

                <div class="flex flex-col flex-1 rounded-box border border-base-content/5 bg-base-100">
                    <table class="table flex-1 table-pin-rows">
                      <thead>
                        <tr>
                          <th></th>
                          <th>Event</th>
                          <th>Timestamp</th>
                          <th>Distance</th>
                          <th id="sn2-head" class="hidden">Sensor 2</th>
                        </tr>
                      </thead>
                      <tbody id="table-body">
                      </tbody>
                    </table>
                  </div>
            </div>
        </div>
        <div class="drawer-side z-10">
            <label for="og-drawer" aria-label="close sidebar" class="drawer-overlay"></label>
            <div class="flex flex-col min-h-full bg-base-200 z-10" id="drawer-inner">
            </div>
        </div>
    </div>

    <script type="module">
        import { loading, garageFetch, sendCommand, updateTitle, updateVersion } from "./common.js";
        const tableBody = document.getElementById("table-body");
        const sn2Head = document.getElementById("sn2-head");

        const currentTime = document.getElementById("current-time");
        const startTime = document.getElementById("start-time");
        const uptime = document.getElementById("uptime");
        const recordCount = document.getElementById("record-count");

        function timeDigit(num) {
            return num.toLocaleString('en-US', {minimumIntegerDigits: 2, useGrouping:false});
        }
 
        async function updateData() {
            const res = await garageFetch("jl");
            const data = await res.json();

            updateTitle(data.name);
            updateVersion(data.fwv);

            tableBody.innerHTML = "";

            if (data.ncols > 3) {
                sn2Head.classList.remove("hidden");
            } else {
                sn2Head.classList.add("hidden");
            }

            currentTime.innerText = new Date(data.time * 1000).toString();
            startTime.innerText = new Date(data.starttime * 1000).toString();
            const delta = data.time - data.starttime;
            const seconds = delta % 60;
            const minutes = Math.floor((delta / 60) % 3600);
            const hours = Math.floor((delta / 3600) % 86400);
            const days = Math.floor(delta / 86400);
            uptime.innerText = days + ":" + timeDigit(hours) + ":" + timeDigit(minutes) + ":" + timeDigit(seconds);
            recordCount.innerText = data.logs.length;

            for (let i = data.logs.length - 1; i >= 0; i--) {
                const log = data.logs[i];
                const row = document.createElement("tr");
                tableBody.appendChild(row);

                const header = document.createElement("th");
                header.innerText = data.logs.length - i;
                row.append(header);

                let col = [];
                switch (log[1]) { // Door status
                    case 0:
                        col.push("Opened");
                        break;
                    case 1:
                        col.push("Closed");
                        break;
                    default:
                        col.push("UNKNOWN");
                        break;
                }

                col.push(new Date(log[0] * 1000).toString());
                col.push(log[2] + " cm");

                if (data.ncols > 3) {
                    switch (log[3]) {
                        case 0:
                        col.push("Low");
                        break;
                    case 1:
                        col.push("High");
                        break;
                    default:
                        col.push("-");
                        break;
                    }
                }

                col.forEach((e) => {
                    const cell = document.createElement("td");
                    cell.innerText = e;
                    row.append(cell);
                });
            }
        }

        updateData();

        setInterval(updateData, 5000);

    </script>
</body>

</html>