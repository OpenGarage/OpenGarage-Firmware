<!DOCTYPE html>
<html>

<head>
    <link href="./output.css" rel="stylesheet">
</head>

<body>
    <div class="drawer">
        <input id="og-drawer" type="checkbox" class="drawer-toggle" />
        <div class="drawer-content">
            <div class="navbar bg-base-100 shadow-sm">
                <div class="navbar-start">
                    <label for="og-drawer" tabindex="0" role="button" class="btn btn-ghost btn-circle drawer-button">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24"
                            stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M4 6h16M4 12h16M4 18h7" />
                        </svg>
                    </label>
                </div>
                <div class="navbar-center">
                    <a id="top-title" class="btn btn-ghost text-xl">Open Garage: Loading</a>
                </div>
                <div class="navbar-end">
                    <label class="swap swap-rotate">
                        <!-- this hidden checkbox controls the state -->
                        <input type="checkbox" id="dark-mode" />

                        <!-- sun icon -->
                        <svg class="swap-off h-10 w-10 fill-current" xmlns="http://www.w3.org/2000/svg"
                            viewBox="0 0 24 24">
                            <path
                                d="M5.64,17l-.71.71a1,1,0,0,0,0,1.41,1,1,0,0,0,1.41,0l.71-.71A1,1,0,0,0,5.64,17ZM5,12a1,1,0,0,0-1-1H3a1,1,0,0,0,0,2H4A1,1,0,0,0,5,12Zm7-7a1,1,0,0,0,1-1V3a1,1,0,0,0-2,0V4A1,1,0,0,0,12,5ZM5.64,7.05a1,1,0,0,0,.7.29,1,1,0,0,0,.71-.29,1,1,0,0,0,0-1.41l-.71-.71A1,1,0,0,0,4.93,6.34Zm12,.29a1,1,0,0,0,.7-.29l.71-.71a1,1,0,1,0-1.41-1.41L17,5.64a1,1,0,0,0,0,1.41A1,1,0,0,0,17.66,7.34ZM21,11H20a1,1,0,0,0,0,2h1a1,1,0,0,0,0-2Zm-9,8a1,1,0,0,0-1,1v1a1,1,0,0,0,2,0V20A1,1,0,0,0,12,19ZM18.36,17A1,1,0,0,0,17,18.36l.71.71a1,1,0,0,0,1.41,0,1,1,0,0,0,0-1.41ZM12,6.5A5.5,5.5,0,1,0,17.5,12,5.51,5.51,0,0,0,12,6.5Zm0,9A3.5,3.5,0,1,1,15.5,12,3.5,3.5,0,0,1,12,15.5Z" />
                        </svg>

                        <!-- moon icon -->
                        <svg class="swap-on h-10 w-10 fill-current" xmlns="http://www.w3.org/2000/svg"
                            viewBox="0 0 24 24">
                            <path
                                d="M21.64,13a1,1,0,0,0-1.05-.14,8.05,8.05,0,0,1-3.37.73A8.15,8.15,0,0,1,9.08,5.49a8.59,8.59,0,0,1,.25-2A1,1,0,0,0,8,2.36,10.14,10.14,0,1,0,22,14.05,1,1,0,0,0,21.64,13Zm-9.5,6.69A8.14,8.14,0,0,1,7.08,5.22v.27A10.15,10.15,0,0,0,17.22,15.63a9.79,9.79,0,0,0,2.1-.22A8.11,8.11,0,0,1,12.14,19.73Z" />
                        </svg>
                    </label>
                </div>
            </div>

            <dialog id="reboot-modal" class="modal">
                <div class="modal-box">
                    <form method="dialog" class="flex flex-col gap-4">
                        <button class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2">✕</button>
                        <h3 class="text-lg font-bold">Reboot your device</h3>
                        <div class="modal-action flex w-full gap-4">
                            <button class="btn btn-outline flex-1">Cancel</button>
                            <button class="btn btn-error flex-1" onclick="rebootDevice()">Reboot</button>
                        </div>
                    </form>
                </div>
            </dialog>

            <dialog id="reset-wifi-modal" class="modal">
                <div class="modal-box">
                    <form method="dialog" class="flex flex-col gap-4">
                        <button class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2">✕</button>
                        <h3 class="text-lg font-bold">Reset to AP Mode</h3>
                        <div class="modal-action flex w-full gap-4">
                            <button class="btn btn-outline flex-1">Cancel</button>
                            <button class="btn btn-error flex-1" onclick="resetWifi()">Reset</button>
                        </div>
                    </form>
                </div>
            </dialog>

            <dialog id="clear-log-modal" class="modal">
                <div class="modal-box">
                    <form method="dialog" class="flex flex-col gap-4">
                        <button class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2">✕</button>
                        <h3 class="text-lg font-bold">Clear Logs on Device</h3>
                        <div class="modal-action flex w-full gap-4">
                            <button class="btn btn-outline flex-1">Cancel</button>
                            <button class="btn btn-error flex-1" onclick="clearLog()">Clear</button>
                        </div>
                    </form>
                </div>
            </dialog>

            <div class="toast toast-bottom toast-end">
                <div class="hidden">
                  <span id="toast"></span>
                </div>
              </div>


            <div class="flex flex-col gap-4">
                <div class="flex flex-1 gap-4">
                    <table class="table shrink max-w-md">
                        <!-- head -->
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <th>Door:</th>
                                <td id="door-status"></td>
                            </tr>
                            <tr>
                                <th>Vehicle:</th>
                                <td id="vehicle-status"></td>
                            </tr>
                            <tr>
                                <th>Distance:</th>
                                <td id="distance-value"></td>
                            </tr>
                            <tr>
                                <th>Read Count:</th>
                                <td id="read-count"></td>
                            </tr>
                            <tr>
                                <th>Sensor 2:</th>
                                <td id="sn2-value"></td>
                            </tr>
                            <tr>
                                <th>Obstructed:</th>
                                <td id="obstructed-status"></td>
                            </tr>
                            <tr>
                                <th>Temperature:</th>
                                <td id="temperature-value"></td>
                            </tr>
                            <tr>
                                <th>Humidity:</th>
                                <td id="humidity-value"></td>
                            </tr>
                            <tr>
                                <th>WiFi Signal:</th>
                                <td id="wifi-signal"></td>
                            </tr>
                            <tr>
                                <th class="">Cloud Status:</th>
                                <td id="cloud-status"></td>
                            </tr>
                        </tbody>
                    </table>

                    <div class="flex flex-col gap-4">
                        <span>
                            Status
                        </span>
                        <div class="shrink h-min p-2">
                            <div class="shrink h-min p-4">
                                <div style='width:112px;height:64px;'>
                                    <img id='car_pic' src='' class='door-img invert-0 dark:invert'>
                                    <img id='door_pic' src='' class='door-img invert-0 dark:invert'>
                                    <img id='arrow_pic' src='' class='door-img invert-0 dark:invert'>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <label class="floating-label">
                    <span>Device Key</span>
                    <input type="password" id="key-input" placeholder="Device Key"
                        class="input input-bordered w-full max-w-md" />
                </label>

                <div id="light-lock" class="flex gap-2">
                    <button class="btn btn-info" onclick="lightAction()"><span id="light-action-text"></span></button>
                    <button class="btn btn-info" onclick="lockAction()"><span id="lock-action-text"></span></button>
                </div>

                <button class="btn btn-wide btn-primary" onclick="doorAction()"><span id="door-action-text"></span></button>
                <div class="flex gap-2">
                    <button class="btn btn-accent" onclick="document.getElementById('reboot-modal').showModal()">Reboot Device</button>
                    <button class="btn btn-accent" onclick="document.getElementById('reset-wifi-modal').showModal()">Reset to AP</button>
                    <button class="btn btn-accent" onclick="document.getElementById('clear-log-modal').showModal()">Clear Log</button>
                </div>
                
            </div>
        </div>
        <div class="drawer-side">
            <label for="og-drawer" aria-label="close sidebar" class="drawer-overlay"></label>
            <div class="flex flex-col min-h-full bg-base-200 z-10">
                <ul class="menu text-base-content w-80 p-4 flex flex-col">
                    <li><a href="/">Home</a></li>
                    <li><a href="/vo">Options</a></li>
                    <li><a href="/vl">View Log</a></li>
                    <li><a href="/update">Firmware Update</a></li>
                    <li><a href="https://github.com/OpenGarage/OpenGarage-Firmware/tree/master/docs">User Manual</a></li>
                </ul>

                <div class="flex-1 flex flex-col justify-end">
                    <div class="flex-1"></div>
                    <div class="flex gap-2">
                        <span>Version:</span><span id="version-number">
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const openGarageRoot = "http://192.168.12.206/";
        const themeSelector = document.getElementById("dark-mode");
        themeSelector.checked = (localStorage.getItem("darkMode") || (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches ? "true" : "false")) == "true";
        document.documentElement.setAttribute("data-theme", themeSelector.checked ? "dark" : "light");
        themeSelector.addEventListener("input", (event) => {
            localStorage.setItem("darkMode", themeSelector.checked);
            document.documentElement.setAttribute("data-theme", themeSelector.checked ? "dark" : "light");
        });

        const toast = document.getElementById("toast");
        let toastTimeout;
        function showToast(level, message) {
            clearTimeout(toastTimeout);
            let toastClass = "alert ";
            switch (level) {
                case 0:
                    toastClass += "alert-info";
                    break;
                case 0:
                    toastClass += "alert-success";
                    break;
                case 2:
                    toastClass += "alert-warning";
                    break;
                case 3:
                    toastClass += "alert-error";
                    break;
            }
            toast.parentElement.className = toastClass;

            toast.innerText = message;

            toastTimeout = setTimeout(() => {
                toast.parentElement.className = "hidden";
            }, 2000);
        }

        const title = document.getElementById("top-title");
        const versionNumber = document.getElementById("version-number");

        const door = document.getElementById("door-status");
        const doorActionText = document.getElementById("door-action-text");

        const lightLock = document.getElementById("light-lock");
        const lightActionText = document.getElementById("light-action-text");
        const lockActionText = document.getElementById("lock-action-text");

        const vehicle = document.getElementById("vehicle-status");
        const distance = document.getElementById("distance-value");
        const readCount = document.getElementById("read-count");
        const sensor2Value = document.getElementById("sn2-value");
        const obstructed = document.getElementById("obstructed-status");
        const temperatureValue = document.getElementById("temperature-value");
        const humidityValue = document.getElementById("humidity-value");
        const wifiSignal = document.getElementById("wifi-signal");
        const cloudStatus = document.getElementById("cloud-status");

        const doorImg = document.getElementById("door_pic");
        const arrowImg = document.getElementById("arrow_pic");
        const carImg = document.getElementById("car_pic");

        const keyInput = document.getElementById("key-input");
        keyInput.value = localStorage.getItem("keyInput");
        keyInput.addEventListener("input", (event) => {
            localStorage.setItem("keyInput", keyInput.value);
        });

        const loading = `<span class="loading loading-dots loading-sm"></span>`;
        door.innerHTML = loading;
        doorActionText.innerHTML = loading;
        lightLock.classList.add("hidden");
        lightActionText.innerHTML = loading;
        lockActionText.innerHTML = loading;
        vehicle.innerHTML = loading;
        distance.innerHTML = loading;
        readCount.innerHTML = loading;
        sensor2Value.innerHTML = loading;
        obstructed.innerHTML = loading;
        temperatureValue.innerHTML = loading;
        humidityValue.innerHTML = loading;
        wifiSignal.innerHTML = loading;
        cloudStatus.innerHTML = loading;
        versionNumber.innerHTML = loading;

        async function sendCommand(type, ...params) {
            params.push('&dkey=' + encodeURIComponent(keyInput.value));
            let res = await fetch(openGarageRoot + type + "?" + params.join("&"));
            let data = await res.json();
            if (data.result != undefined) {
                switch (data.result) {
                    case 1: //Success
                        break;
                    case 2: //Invalid device key
                        showToast(3, "Invalid device key");
                        break;
                        //Ignore other cases
                    default:
                        break;
                }
            }
        }

        function rebootDevice() {
            sendCommand("cc", "reboot=1");
        }

        function resetWifi() {
            sendCommand("cc", "apmode=1");
        }

        function clearLog() {
            sendCommand("clearlog");
        }

        function doorAction() {
            sendCommand("cc", "click=1");
            setTimeout(updateData, 500);
        }

        function lightAction() {
            sendCommand("cc", "light=toggle");
            setTimeout(updateData, 100);
        }

        function lockAction() {
            sendCommand("cc", "lock=toggle");
            setTimeout(updateData, 100);
        }

        function getDigits(n, count) {
            return new Array(count).fill(undefined).map(() => {
                const r = n % 10;
                n = Math.floor(n/10);
                return r;
            });
        }

        async function updateData() {
            const res = await fetch(openGarageRoot +"jc");
            const data = await res.json();

            let doorStatusText;
            let doorStatusColor;
            let base = "image/";

            switch (data.door) {
                case 0: // Closed
                    doorStatusText = "Closed";
                    doorActionText.innerText = "Open Door";
                    doorStatusColor = "text-success";
                    doorImg.src = base + "closed.svg";
                    arrowImg.src = "";
                    break;
                case 1: // Open
                    doorStatusText = "Open";
                    doorActionText.innerText = "Close Door";
                    doorStatusColor = "text-error";
                    doorImg.src = base + "open.svg";
                    arrowImg.src = "";
                    break;
                case 3: // Stopped
                    doorStatusText = "Stopped";
                    doorActionText.innerText = "Toggle Door";
                    doorStatusColor = "text-error";
                    doorImg.src = base + "partial.svg";
                    arrowImg.src = "";
                    break;
                case 4: // Closing
                    doorStatusText = "Closing";
                    doorActionText.innerText = "Open Door";
                    doorStatusColor = "text-success";
                    doorImg.src = base + "partial.svg";
                    arrowImg.src = base + "arrow_down.svg";
                    break;
                case 5: // Opening
                    doorStatusText = "Opening";
                    doorActionText.innerText = "Stop Door";
                    doorStatusColor = "text-error";
                    doorImg.src = base + "partial.svg";
                    arrowImg.src = base + "arrow_up.svg";
                    break;
                case 2: // UNKNOWN / UNSET
                default:
                    doorStatusText = "Unknown";
                    doorActionText.innerText = "Unknown";
                    doorStatusColor = "text-error";
                    doorImg.src = "";
                    arrowImg.src = "";
                    break;
            }

            if (data.light == undefined || data.lock == undefined) {
                lightLock.classList.add("hidden");
            } else {
                lightLock.classList.remove("hidden");
                if (data.light) {
                    lightActionText.innerText = `Turn Off Light`;
                    lightActionText.parentElement.className = "btn btn-warning";
                } else {
                    lightActionText.innerText = `Turn On Light`;
                    lightActionText.parentElement.className = "btn btn-info";
                }

                if (data.lock) {
                    lockActionText.innerText = `Unlock Remotes`;
                    lockActionText.parentElement.className = "btn btn-error";
                } else {
                    lockActionText.innerText = `Lock Remotes`;
                    lockActionText.parentElement.className = "btn btn-info";
                }
            }

            let vehicleStatusText;

            switch (data.vehicle) {
                default:
                    carImg.src = "";
                    vehicleStatusText = "Absent";
                    break;
                case 1:
                    carImg.src = base + "car.svg";
                    carImg.className = "door-img brightness-0 dark:brightness-200";
                    vehicleStatusText = "Detected";
                    break;
                case 2:
                    carImg.src = base + "car.svg";
                    carImg.className = "door-img invert-0 dark:invert";
                    vehicleStatusText = "Unavailable";
                    break;
            }

            title.innerText = data.name;
            const versionDigits = getDigits(data.fwv, 3);
            versionNumber.innerText = versionDigits[2] + "." + versionDigits[1] + "." + versionDigits[0];

            door.innerText = doorStatusText;
            door.className = doorStatusColor;
            vehicle.innerText = vehicleStatusText;
            distance.innerText = data.dist + " (cm)";
            readCount.innerText = data.rcnt;
            obstructed.innerText = data.obstruct;

            if (data.sn2 == undefined) {
                sensor2Value.parentElement.classList.add("hidden");
            } else {
                sensor2Value.parentElement.classList.remove("hidden");
                sensor2Value.innerText = data.sn2 ? "High" : "Low";
            }

            if (data.temp == undefined) {
                temperatureValue.parentElement.classList.add("hidden");
            } else {
                temperatureValue.parentElement.classList.remove("hidden");
                temperatureValue.innerText = `${data.temp.toFixed(1)} \u00B0C (${((data.temp * 9/5) + 32).toFixed(1)} \u00B0F)`;
            }

            if (data.humidity == undefined) {
                humidityValue.parentElement.classList.add("hidden");
            } else {
                humidityValue.parentElement.classList.remove("hidden");
                humidityValue.innerText = data.humidity.toFixed(1) + "%";
            }

            wifiSignal.innerText = (data.rssi > -71 ? 'Good' : (data.rssi > -81 ? 'Weak' : 'Poor')) + ' (' + data.rssi + ' dBm)';
            let cloudStatusText;
            switch (data.cld) {
                default:
                    cloudStatusText = "None";
                    break;
                case 1: //Blynk
                    cloudStatusText = "Blynk " + ["(disconnected)", "(connected)"][data.clds];
                    break;
                case 2: //OTC
                    cloudStatusText = "OTC " + ['(not enabled)', '(connecting...)', '(disconnected)', '(connected)'][data.clds];
                    break;
            }

            cloudStatus.innerText = cloudStatusText;
        }

        updateData();

        setInterval(updateData, 1000);

    </script>
</body>

</html>