<!DOCTYPE html>
<html>

<head>
    <title>Open Garage</title>
    <link href="./output.css" rel="stylesheet">
</head>

<body class="hidden">
    <div class="drawer">
        <input id="og-drawer" type="checkbox" class="drawer-toggle" />
        <div class="drawer-content max-h-screen flex flex-col" id="drawer-content">
            <dialog id="reboot-modal" class="modal">
                <div class="modal-box">
                    <form method="dialog" class="flex flex-col gap-4">
                        <button class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2">✕</button>
                        <h3 class="text-lg font-bold">Reboot your device</h3>
                        <div class="modal-action flex w-full gap-4">
                            <button class="btn btn-outline flex-1">Cancel</button>
                            <button class="btn btn-error flex-1" id="reboot-button">Reboot</button>
                        </div>
                    </form>
                </div>
            </dialog>

            <dialog id="reset-wifi-modal" class="modal">
                <div class="modal-box">
                    <form method="dialog" class="flex flex-col gap-4">
                        <button class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2">✕</button>
                        <h3 class="text-lg font-bold">Reset to AP Mode</h3>
                        <div class="modal-action flex w-full gap-4">
                            <button class="btn btn-outline flex-1">Cancel</button>
                            <button class="btn btn-error flex-1" id="reset-wifi">Reset</button>
                        </div>
                    </form>
                </div>
            </dialog>

            <dialog id="clear-log-modal" class="modal">
                <div class="modal-box">
                    <form method="dialog" class="flex flex-col gap-4">
                        <button class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2">✕</button>
                        <h3 class="text-lg font-bold">Clear Logs on Device</h3>
                        <div class="modal-action flex w-full gap-4">
                            <button class="btn btn-outline flex-1">Cancel</button>
                            <button class="btn btn-error flex-1" id="clear-log">Clear</button>
                        </div>
                    </form>
                </div>
            </dialog>

            <div class="flex-1 overflow-auto flex flex-col gap-4">
                <div class="flex flex-1 gap-4">
                    <table class="table shrink max-w-md">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <th>Door:</th>
                                <td id="door-status"></td>
                            </tr>
                            <tr>
                                <th>Vehicle:</th>
                                <td id="vehicle-status"></td>
                            </tr>
                            <tr>
                                <th>Distance:</th>
                                <td id="distance-value"></td>
                            </tr>
                            <tr>
                                <th>Read Count:</th>
                                <td id="read-count"></td>
                            </tr>
                            <tr>
                                <th>Sensor 2:</th>
                                <td id="sn2-value"></td>
                            </tr>
                            <tr>
                                <th>Obstructed:</th>
                                <td id="obstructed-status"></td>
                            </tr>
                            <tr>
                                <th>Temperature:</th>
                                <td id="temperature-value"></td>
                            </tr>
                            <tr>
                                <th>Humidity:</th>
                                <td id="humidity-value"></td>
                            </tr>
                            <tr>
                                <th>WiFi Signal:</th>
                                <td id="wifi-signal"></td>
                            </tr>
                            <tr>
                                <th class="">Cloud Status:</th>
                                <td id="cloud-status"></td>
                            </tr>
                        </tbody>
                    </table>

                    <div class="flex flex-col gap-4">
                        <span>
                            Status
                        </span>
                        <div class="shrink h-min p-2">
                            <div class="shrink h-min p-4">
                                <div style='width:112px;height:64px;'>
                                    <img id='car-pic' src='' class='door-img invert-0 dark:invert'>
                                    <img id='door-pic' src='' class='door-img invert-0 dark:invert'>
                                    <img id='arrow-pic' src='' class='door-img invert-0 dark:invert'>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <label class="floating-label">
                    <span>Device Key</span>
                    <input type="password" id="key-input" placeholder="Device Key"
                        class="input input-bordered w-full max-w-md" />
                </label>

                <div id="light-lock" class="flex gap-2">
                    <button class="btn btn-info" id="light-action"><span id="light-action-text"></span></button>
                    <button class="btn btn-info" id="lock-action"><span id="lock-action-text"></span></button>
                </div>

                <button class="btn btn-wide btn-primary" id="door-action"><span id="door-action-text"></span></button>
                <div class="flex gap-2">
                    <button class="btn btn-accent" onclick="document.getElementById('reboot-modal').showModal()">Reboot
                        Device</button>
                    <button class="btn btn-accent"
                        onclick="document.getElementById('reset-wifi-modal').showModal()">Reset to AP</button>
                    <button class="btn btn-accent"
                        onclick="document.getElementById('clear-log-modal').showModal()">Clear Log</button>
                </div>

            </div>
        </div>
        <div class="drawer-side z-10">
            <label for="og-drawer" aria-label="close sidebar" class="drawer-overlay"></label>
            <div class="flex flex-col min-h-full bg-base-200 z-10" id="drawer-inner">
            </div>
        </div>
    </div>

    <script type="module">
        import { loading, garageFetch, sendCommand, updateTitle, updateVersion } from "./common.js";
        const door = document.getElementById("door-status");
        const doorActionText = document.getElementById("door-action-text");

        const lightLock = document.getElementById("light-lock");
        const lightActionText = document.getElementById("light-action-text");
        const lockActionText = document.getElementById("lock-action-text");

        const vehicle = document.getElementById("vehicle-status");
        const distance = document.getElementById("distance-value");
        const readCount = document.getElementById("read-count");
        const sensor2Value = document.getElementById("sn2-value");
        const obstructed = document.getElementById("obstructed-status");
        const temperatureValue = document.getElementById("temperature-value");
        const humidityValue = document.getElementById("humidity-value");
        const wifiSignal = document.getElementById("wifi-signal");
        const cloudStatus = document.getElementById("cloud-status");

        const doorImg = document.getElementById("door-pic");
        const arrowImg = document.getElementById("arrow-pic");
        const carImg = document.getElementById("car-pic");

        const keyInput = document.getElementById("key-input");
        keyInput.value = localStorage.getItem("keyInput");
        keyInput.addEventListener("input", (event) => {
            localStorage.setItem("keyInput", keyInput.value);
        });

        lightLock.classList.add("hidden");

        loading(door,
            doorActionText,
            lightActionText,
            lockActionText,
            vehicle,
            distance,
            readCount,
            sensor2Value,
            obstructed,
            temperatureValue,
            humidityValue,
            wifiSignal,
            cloudStatus);

        document.getElementById("reboot-button").addEventListener("click", () => {
            sendCommand("cc", keyInput.value, "reboot=1");
        });

        document.getElementById("reset-wifi").addEventListener("click", () => {
            sendCommand("cc", keyInput.value, "apmode=1");
        });

        document.getElementById("clear-log").addEventListener("click", () => {
            sendCommand("clearlog", keyInput.value);
        });

        document.getElementById("door-action").addEventListener("click", () => {
            sendCommand("cc", keyInput.value, "click=1");
            setTimeout(updateData, 500);
        });

        document.getElementById("light-action").addEventListener("click", () => {
            sendCommand("cc", keyInput.value, "light=toggle");
            setTimeout(updateData, 100);
        });

        document.getElementById("lock-action").addEventListener("click", () => {
            sendCommand("cc", keyInput.value, "lock=toggle");
            setTimeout(updateData, 100);
        });

        async function updateData() {
            const res = await garageFetch("jc");
            const data = await res.json();

            let doorStatusText;
            let doorStatusColor;
            let base = "image/";

            switch (data.door) {
                case 0: // Closed
                    doorStatusText = "Closed";
                    doorActionText.innerText = "Open Door";
                    doorStatusColor = "text-success";
                    doorImg.src = base + "closed.svg";
                    arrowImg.src = "";
                    break;
                case 1: // Open
                    doorStatusText = "Open";
                    doorActionText.innerText = "Close Door";
                    doorStatusColor = "text-error";
                    doorImg.src = base + "open.svg";
                    arrowImg.src = "";
                    break;
                case 3: // Stopped
                    doorStatusText = "Stopped";
                    doorActionText.innerText = "Toggle Door";
                    doorStatusColor = "text-error";
                    doorImg.src = base + "partial.svg";
                    arrowImg.src = "";
                    break;
                case 4: // Closing
                    doorStatusText = "Closing";
                    doorActionText.innerText = "Open Door";
                    doorStatusColor = "text-success";
                    doorImg.src = base + "partial.svg";
                    arrowImg.src = base + "arrow_down.svg";
                    break;
                case 5: // Opening
                    doorStatusText = "Opening";
                    doorActionText.innerText = "Stop Door";
                    doorStatusColor = "text-error";
                    doorImg.src = base + "partial.svg";
                    arrowImg.src = base + "arrow_up.svg";
                    break;
                case 2: // UNKNOWN / UNSET
                default:
                    doorStatusText = "Unknown";
                    doorActionText.innerText = "Unknown";
                    doorStatusColor = "text-error";
                    doorImg.src = "";
                    arrowImg.src = "";
                    break;
            }

            if (data.light == undefined || data.lock == undefined) {
                lightLock.classList.add("hidden");
            } else {
                lightLock.classList.remove("hidden");
                if (data.light) {
                    lightActionText.innerText = `Turn Off Light`;
                    lightActionText.parentElement.className = "btn btn-warning";
                } else {
                    lightActionText.innerText = `Turn On Light`;
                    lightActionText.parentElement.className = "btn btn-info";
                }

                if (data.lock) {
                    lockActionText.innerText = `Unlock Remotes`;
                    lockActionText.parentElement.className = "btn btn-error";
                } else {
                    lockActionText.innerText = `Lock Remotes`;
                    lockActionText.parentElement.className = "btn btn-info";
                }
            }

            let vehicleStatusText;

            switch (data.vehicle) {
                default:
                    carImg.src = "";
                    vehicleStatusText = "Absent";
                    break;
                case 1:
                    carImg.src = base + "car.svg";
                    carImg.className = "door-img brightness-0 dark:brightness-200";
                    vehicleStatusText = "Detected";
                    break;
                case 2:
                    carImg.src = base + "car.svg";
                    carImg.className = "door-img invert-0 dark:invert";
                    vehicleStatusText = "Unavailable";
                    break;
            }

            updateTitle(data.name);
            updateVersion(data.fwv);

            door.innerText = doorStatusText;
            door.className = doorStatusColor;
            vehicle.innerText = vehicleStatusText;
            distance.innerText = data.dist + " (cm)";
            readCount.innerText = data.rcnt;
            obstructed.innerText = data.obstruct;

            if (data.sn2 == undefined) {
                sensor2Value.parentElement.classList.add("hidden");
            } else {
                sensor2Value.parentElement.classList.remove("hidden");
                sensor2Value.innerText = data.sn2 ? "High" : "Low";
            }

            if (data.temp == undefined) {
                temperatureValue.parentElement.classList.add("hidden");
            } else {
                temperatureValue.parentElement.classList.remove("hidden");
                temperatureValue.innerText = `${data.temp.toFixed(1)} \u00B0C (${((data.temp * 9 / 5) + 32).toFixed(1)} \u00B0F)`;
            }

            if (data.humidity == undefined) {
                humidityValue.parentElement.classList.add("hidden");
            } else {
                humidityValue.parentElement.classList.remove("hidden");
                humidityValue.innerText = data.humidity.toFixed(1) + "%";
            }

            wifiSignal.innerText = (data.rssi > -71 ? 'Good' : (data.rssi > -81 ? 'Weak' : 'Poor')) + ' (' + data.rssi + ' dBm)';
            let cloudStatusText;
            switch (data.cld) {
                default:
                    cloudStatusText = "None";
                    break;
                case 1: //Blynk
                    cloudStatusText = "Blynk " + ["(disconnected)", "(connected)"][data.clds];
                    break;
                case 2: //OTC
                    cloudStatusText = "OTC " + ['(not enabled)', '(connecting...)', '(disconnected)', '(connected)'][data.clds];
                    break;
            }

            cloudStatus.innerText = cloudStatusText;
        }

        updateData();

        setInterval(updateData, 1000);

    </script>
</body>

</html>