<head><title>OpenGarage</title><meta name='viewport' content='width=device-width, initial-scale=1'><link rel='stylesheet' href='https://code.jquery.com/mobile/1.3.1/jquery.mobile-1.3.1.min.css' type='text/css'><script src='https://code.jquery.com/jquery-1.9.1.min.js' type='text/javascript'></script><script src='https://code.jquery.com/mobile/1.3.1/jquery.mobile-1.3.1.min.js' type='text/javascript'></script></head>
<body>
<style> table, th, td {border: 0px solid black;padding: 6px; border-collapse: collapse; } .img {width: inherit; height: inherit; position: absolute; top: inherit; left: inherit;} .img[src=""] {display:none;} 
.lightlock-ctrl div.ui-slider-switch {width:160px;}
</style>
<div data-role='page' id='page_home'><div data-role='header'><h3 id='head_name'>OG</h3></div>
<div data-role='content'><div data-role='fieldcontain'>
<table><tr><td><b>Door:<br></td><td><label id='lbl_status'>-</label></td>
<td rowspan='2'><div id='pic' style='width:112px;height:64px;'><img id='car_pic' src='' class='img'><img id='door_pic' src='' class='img'><img id='arrow_pic' src='' class='img'></div></td></tr>
<tr><td><b><label id='lbl_vstatus1'>Vehicle:</label></b></td><td><label id='lbl_vstatus'>-</label></td></tr>
<tr><td><b>Distance:</b></td><td><label id='lbl_dist'>-</label></td><td></td></tr>
<tr><td><b>Read Cnt.:</b></td><td><label id='lbl_beat'>-</label></td><td></td></tr>
<tr id='tbl_sn2' style='display:none'><td><b>Switch Sn.:</b></td><td><label id='lbl_sn2'>-</label></td><td></td></tr>
<tr id='tbl_obstruct' style='display:none'><td><b>Obstructed:</b></td><td><label id='lbl_obstruct'>-</label></td><td></td></tr>
<tr><td><b>WiFi Signal:</b></td><td colspan='2'><label id='lbl_rssi'>-</label></td></tr>
<tr><td><b>Cloud:</b></td><td colspan='2'><label id='lbl_cld'>-</label></td></tr>
<tr id='tbl_th'><td><b>T/H sensor:</b></td><td colspan='2'><label id='lbl_th'>-</label></td></tr>
<tr><td><b>Device Key:</b></td><td colspan='2' ><input type='password' size=20 maxlength=64 name='dkey' id='dkey'></td></tr>
<tr><td colspan=3><label id='msg'></label></td></tr>
</table>
<div class="lightlock-ctrl" style='display:none'>
<label for="lightflip" class="ui-hidden-accessible"></label>
<select name="lightflip" id="lightflip" data-theme="e" data-role="slider">
<option value=0>Light Off</option>
<option value=1>Light On</option>
</select>
<label for="lockflip" class="ui-hidden-accessible"></label>
<select name="lockflip" id="lockflip" data-theme="e" data-role="slider">
<option value=0>Lock Inactive</option>
<option value=1>Lock Active</option>
</select>
</div>
<span style='display:block;height:5px'></span>
<div data-role='controlgroup' data-type='horizontal'>
<button data-theme='b' id='btn_click'>Door</button>
<button data-theme='b' id='btn_opts'>Options</button>
<button data-theme='b' id='btn_log'>View Log</button>
</div>
<span style='display:block;height:5px'></span>
<div data-role='controlgroup' data-type='horizontal'>
<button data-theme='c' id='btn_rbt'>Reboot</button>
<button data-theme='c' id='btn_rap'>Reset WiFi</button>
<button data-theme='c' id='btn_cll'>Clear Log</button>
</div>
</div>
</div>
<div data-role='footer' data-theme='c'>
<p>&nbsp; OpenGarage Firmware v<label id='fwv'>-</label><div data-role='controlgroup' data-type='horizontal'><a href='update' target='_top' data-role='button' data-inline=true data-mini=true>Firmware Update</a><a href='https://github.com/OpenGarage/OpenGarage-Firmware/tree/master/docs' target='_blank' data-role='button' data-inline=true data-mini=true>User Manual</a></p></div>
</div>
</div>
<script>
var si;
function clear_msg() {$('#msg').text('');}
function show_msg(s,t,c) { $('#msg').text(s).css('color',c); if(t>0) setTimeout(clear_msg, t); }
$('#btn_opts').click(function(e){window.open('vo', '_top');});
$('#btn_log').click(function(e){window.open('vl', '_top');});
$('#btn_cll').click(function(e){
	if(confirm('Clear log data?')){
		var comm = 'clearlog?dkey='+encodeURIComponent($('#dkey').val());
		clear_msg();
		$.getJSON(comm, function(jd) {
			if(jd.result!=1) show_msg('Check device key and try again.',2000,'red');
			else { show_msg('Log data cleared',2000,'green'); }
		});
	}
});
$('#btn_rbt').click(function(e){
	if(confirm('Reboot the device now?')){
		var comm = 'cc?reboot=1&dkey='+encodeURIComponent($('#dkey').val());
		clear_msg();
		$.getJSON(comm, function(jd) {
			if(jd.result!=1) show_msg('Check device key and try again.',2000,'red');
			else {
				show_msg('Rebooting. Please wait...',0,'green');
				clearInterval(si);
				setTimeout(function(){location.reload(true);}, 10000);
			}
		});
	}
});
$('#btn_rap').click(function(e){
	if(confirm('Reset the device to AP mode?')){
		var comm = 'cc?apmode=1&dkey='+encodeURIComponent($('#dkey').val());
		clear_msg();
		$.getJSON(comm, function(jd) {
			if(jd.result!=1) show_msg('Check device key and try again.',2000,'red');
			else {
				clearInterval(si);
				$('#msg').html('Device is now in AP mode. Log on<br>to SSID OG_xxxxxx, then <br> click <a href="http://192.168.4.1">http://192.168.4.1</a><br>to configure.').css('color','green');
			}
		});
	}
});
function do_action_command(comm) {
	var comm = 'cc?'+comm+'&dkey='+encodeURIComponent($('#dkey').val());
	$.getJSON(comm)
	.done(function( jd ) {
		if(jd.result!=1) {
			show_msg('Check device key and try again.',2000,'red');
		}else{clear_msg();};
	})
	.fail(function( jqxhr, textStatus, error ) {
		var err = error;
		$('#msg').text('Request Failed: ' + err).css('color','red');
	});
}
$('#lightflip').on('change', function(e) {
	do_action_command('light=toggle');
});
$('#lockflip').on('change', function(e) {
	do_action_command('lock=toggle');
});
$('#btn_click').click(function(e) {
	do_action_command('click=1');
});
$(document).ready(function() { show(); si=setInterval('show()', 5000); });
function show() {
	$.ajax({
	url:'jc',
	dataType:'JSON',
	timeout:5000,
	success:function(jd){
		$('#fwv').text((jd.fwv/100>>0)+'.'+(jd.fwv/10%10>>0)+'.'+(jd.fwv%10>>0));
		$('#lbl_dist').text(jd.dist +' (cm)').css('color', jd.dist==450?'red':'black');
		let status_text;
		let status_color;
		const door_img = document.getElementById("door_pic");
		const arrow_img = document.getElementById("arrow_pic");
		let base = "https://raw.githubusercontent.com/OpenGarage/OpenGarage-Firmware/refs/heads/dev/1.2.4/icons/parts/";

		switch (jd.door) {
			case 0: // Closed
				status_text = "CLOSED";
				status_color = "green";
				door_img.src = base+"closed.svg"
				arrow_img.src = ""
				break;
			case 1: // Open
				status_text = "OPENED";
				status_color = "red";
				door_img.src = base+"open.svg"
				arrow_img.src = ""
				break;
			case 3: // Stopped
				status_text = "STOPPED";
				status_color = "red";
				door_img.src = base+"partial.svg"
				arrow_img.src = ""
				break;
			case 4: // Closing
				status_text = "CLOSING";
				status_color = "green";
				door_img.src = base+"partial.svg"
				arrow_img.src = base+"arrow_down.svg"
				break;
			case 5: // Opening
				status_text = "OPENING";
				status_color = "red";
				door_img.src = base+"partial.svg"
				arrow_img.src = base+"arrow_up.svg"
				break;
			case 2: // UNKNOWN / UNSET
			default:
				status_text = "UNKNOWN";
				status_color = "red";
				break;
		}
		$('#lbl_status').text(status_text).css('color', status_color);
        if(typeof(jd.light)=='undefined'||typeof(jd.lock)=='undefined') {
            $('.lightlock-ctrl').hide();
        }else{
            $('.lightlock-ctrl').show();
            $('#lightflip').val(jd.light).slider('refresh');
            $('#lockflip').val(jd.lock).slider('refresh');
        }
		if (jd.vehicle >=2){
			$('#lbl_vstatus1').hide();
			$('#lbl_vstatus').text('');
		}else{
			$('#lbl_vstatus1').show()
			$('#lbl_vstatus').text(jd.vehicle == 1 ?'Present':(jd.vehicle == 0 ?'Absent':'Unavailable'));
		}
		const car_img = document.getElementById("car_pic");
		if(jd.vehicle < 3 && jd.vehicle > 0) {
			car_img.src = base+"car.svg";
			car_img.style.filter=jd.vehicle == 1 ? 'brightness(0)' : '';
		}else{
			car_img.src = "";
		}
		if(typeof(jd.sn2)!='undefined') {$('#tbl_sn2').show(); $('#lbl_sn2').text(jd.sn2?'High':'Low');}
		else {$('#tbl_sn2').hide();}
		$('#lbl_beat').text(jd.rcnt).css('color','black');
		$('#lbl_rssi').text((jd.rssi>-71?'Good':(jd.rssi>-81?'Weak':'Poor')) +' ('+ jd.rssi +' dBm)');
		if(jd.cld==0) $('#lbl_cld').text('None');
		else if(jd.cld==1) {$('#lbl_cld').text('Blynk '+['(disconnected)','(connected)'][jd.clds]);}
		else {$('#lbl_cld').text('OTC '+['(not enabled)','(connecting...)','(disconnected)','(connected)'][jd.clds]);}
		$('#head_name').text(jd.name);
		$('#btn_click').html(jd.door?'Close Door':'Open Door').button('refresh');
		if(typeof(jd.temp)!='undefined') {$('#tbl_th').show(); $('#lbl_th').text(jd.temp.toFixed(1)+String.fromCharCode(176)+'C / '+(jd.temp*1.8+32).toFixed(1)+String.fromCharCode(176)+'F (H:'+jd.humid.toFixed(1)+'%)');}
		else {$('#tbl_th').hide();}
		if(typeof(jd.obstruct)!='undefined') {$('#tbl_obstruct').show(); $('#lbl_obstruct').text(jd.obstruct?'YES':'no').css('color',jd.obstruct?'red':'black');} else {$('#tbl_obstruct').hide();}
	},
	error:function(){
		$('#lbl_beat').text('(offline)').css('color','red');
		$('#lbl_cld').text('disconnected');
	}
	});
}
</script>
</body>
